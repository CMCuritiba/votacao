{% extends "base_admin.html" %}
{% load crispy_forms_tags %}

{% block title %}Liberação de Votação{% endblock %}

{% block content %}

    <div class="panel panel-primary">
        <div class="panel-heading">Reuniões em : {% now "d/m/Y" %}</div>
        <div class="panel-body">
            <div class="row">
                <div class="col-sm-12">
                    <table id="treunioes" class="table table-striped table-hover table-bordered fonteTable" width="100%" cellspacing="0"></table>
                </div>
            </div>
        </div>
    </div>

    <div class="panel panel-primary">
        <div class="panel-heading">Projetos da Reunião : <span id="tit_reuniao"></span></div>
        <div class="panel-body">
            <div class="row">
                <div class="col-sm-12">
                    <table id="tprojetos" class="table table-striped table-hover table-bordered fonteTable" width="100%" cellspacing="0"></table>
                </div>
            </div>
        </div>
    </div>

{% endblock %}    

{% block extra_javascript %}

    <script>

        var tableReunioes;
        var tableProjetos;
        var algumAberto=false;


        function verifica_aberto() {
            request_url = "/api/verifica_abertos/";

            $.ajax({
                url: request_url,
                type: 'GET',
                accepts: 'application/json',
                dataType: 'json',
                success: function(result){
                    if (result.status == 'false') {
                        algumAberto = true;
                        console.log(algumAberto);
                    }
                    else {
                        algumAberto = false;
                        console.log(algumAberto);
                    }
                },
                error: function(xhr, status, error) {
                    console.log('Problema ao carregar informações do projeto.');
                }
            })
        }

        $(document).ready(function() {

            
            $.fn.dataTable.ext.errMode = 'none';

            tableReunioes = $('#treunioes').DataTable({
                "fnInitComplete": function(oSettings, json) {
                    inicializaSelecao();
                },
                rowReorder: {
                    selector: 'td:nth-child(2)'
                },
                select: {
                    style: 'single'
                },
                responsive: true,
                "order": [[ 1, "asc" ]],
                "columns": [
                    { 
                        title: "pac_id" ,
                        data: 'pac_id'
                    },
                    { 
                        title: "Número" ,
                        data: 'rec_numero',
                    },
                    { 
                        title: "Comissão",
                        data: 'con_desc',
                    },
                    { 
                        title: "Data",
                        data: 'rec_data',
                    },
                    { 
                        title: "Tipo",
                        data: 'rec_tipo_reuniao',
                    },
                    
                ],
                "columnDefs": [
                    {
                        "targets": [0],
                        "visible": false,
                        "searchable": false
                    },
                    {
                        "targets": [1],
                        "visible": true,
                        "searchable": false
                    },
                    {
                        "targets": [2],
                        "visible": true,
                        "searchable": false
                    },
                    {
                        "targets": [3],
                        "visible": true,
                        "searchable": false
                    },
                    {
                        "targets": [4],
                        "visible": true,
                        "searchable": false
                    },
                            

                ],
                "language": {
                    "info": "Páginas _PAGE_ de _PAGES_",
                    "emptyTable": "Não há reuniões agendadas para hoje",
                    "decimal": ",",
                    "thousands": ".",
                    "oPaginate": {
                        "sFirst": '<span class="glyphicon glyphicon-fast-backward"></span>',
                        "sLast": '<span class="glyphicon glyphicon-fast-forward"></span>',
                        "sNext": '<span class="glyphicon glyphicon-forward"></span>',
                        "sPrevious": '<span class="glyphicon glyphicon-backward"></span>'
                    }
                },
                "deferRender": true,
                "bPaginate" : true,
                "bLengthChange": false,
                "bFilter": true,
                "bInfo": false,
                "ajax": {
                    "url": "/api/consome_reuniao_comissao",
                    "dataSrc": "",
                },
                "sDom": '<"top"i>rt<"bottom"lp><"clear">',
            });


            tableProjetos = $('#tprojetos').DataTable({
                rowReorder: {
                    selector: 'td:nth-child(2)'
                },
                responsive: true,
                "order": [[ 2, "asc" ]],
                "columns": [
                    { 
                        title: "par_id" ,
                        data: 'par_id'
                    },
                    { 
                        title: "status" ,
                        data: 'status'
                    },

                    { 
                        title: "Projeto" ,
                        data: 'codigo_proposicao',
                    },
                    { 
                        title: "Iniciativa",
                        data: 'iniciativa',
                    },
                    { 
                        title: "Relator" ,
                        data: 'relator',
                    },
                    
                ],
                "columnDefs": [
                    {
                        "targets": [0],
                        "visible": false,
                        "searchable": false
                    },
                    {
                        "targets": [1],
                        "visible": false,
                        "searchable": false
                    },
                    {
                        "targets": [2],
                        "visible": true,
                        "searchable": false
                    },
                    {
                        "targets": [3],
                        "visible": true,
                        "searchable": false
                    },
                    {
                        "targets": [4],
                        "visible": true,
                        "searchable": false
                    },
                    {
                        "targets": [5],
                        "data": null,
                        "render" : function(data, type, full, meta) {
                            if (full.status == 'A') {
                                return "<a href='javascript:fechaVotacao(" + full.pac_id + "," + full.par_id + ",\"" + full.codigo_proposicao + "\")'><span id='abre' class='badge progress-bar-danger'>Fechar Votação</span></a>";
                            }
                            else if (full.status == 'F' && !algumAberto) {
                                return "<a href='javascript:abreVotacao(" + full.pac_id + "," + full.par_id + ",\"" + full.codigo_proposicao + "\")'><span id='abre' class='badge progress-bar-success'>Abrir Votação</span></a>";
                            }
                            else if (full.status == 'V') {
                                return "<span id='abre' class='badge progress-bar-warning'>Projeto Votado</span>";
                            }
                            else {
                                return "";
                            }
                        },
                        "className": "dt-center"
                    },
                ],
                "language": {
                    "info": "Páginas _PAGE_ de _PAGES_",
                    "emptyTable": "Não há projetos nesta pauta",
                    "decimal": ",",
                    "thousands": ".",
                    "oPaginate": {
                        "sFirst": '<span class="glyphicon glyphicon-fast-backward"></span>',
                        "sLast": '<span class="glyphicon glyphicon-fast-forward"></span>',
                        "sNext": '<span class="glyphicon glyphicon-forward"></span>',
                        "sPrevious": '<span class="glyphicon glyphicon-backward"></span>'
                    }
                },
                "pageLength": 8,
                "deferRender": true,
                "bPaginate" : true,
                "bLengthChange": false,
                "bFilter": true,
                "bInfo": false,
                "ajax": {
                    "processing": true,
                    "url": "",
                    "dataSrc": "",
                },
                "sDom": '<"top"i>rt<"bottom"lp><"clear">',

            });

        });

        $('#treunioes').on( 'click', 'tr', function () {
            if ( $(this).hasClass('selected') ) {
                limpaTabelaProjetos();
                $(this).removeClass('selected');
            }
            else {
                if (tableReunioes.data().any()) {
                    tableReunioes.$('tr.selected').removeClass('selected');
                    data = tableReunioes.row(this).data();
                    titulo = data['rec_numero'] + " " + data['con_desc'];
                    carregaProjetos(data['pac_id'], titulo);
                    $(this).addClass('selected');
                } 
                else {
                    tableReunioes.clear();
                    carregaProjetos(0, 0);
                }
            }
        });

        function carregaProjetos(pac_id, titulo) {

            url = "/api/consome_projetos/" + pac_id + "/";
            verifica_aberto();
            $('#tit_reuniao').empty();
            $('#tit_reuniao').append(titulo);
            tableProjetos.ajax.url(url).load();
        }

        function inicializaSelecao() {
             $('#treunioes tbody tr:eq(0)').click(); 
        }

        function limpaTabelaProjetos() {
            $('#tit_reuniao').empty();
            tableProjetos.clear().draw();   
        }

        function abreVotacao(pac_id, par_id, codigo_proposicao) {
            request_url = "/api/abre_votacao/" + pac_id + "/" + par_id + "/" + codigo_proposicao + "/";

            $.ajax({
                url: request_url,
                xhrFields: {
                    withCredentials: true
                },
                type: 'POST',
                data: {csrfmiddlewaretoken: '{{csrf_token}}'},
                accepts: 'application/json',
                dataType: 'json',
                success: function(result){
                    verifica_aberto();
                    tableProjetos.ajax.reload(null, false);
                },
                error: function(xhr, status, error) {
                    console.log(status);
                    console.log(error);
                    console.log(xhr);
                }
            })
        }

        function fechaVotacao(pac_id, par_id, codigo_proposicao) {
            request_url = "/api/fecha_votacao/" + pac_id + "/" + par_id + "/" + codigo_proposicao + "/";

            $.ajax({
                url: request_url,
                xhrFields: {
                    withCredentials: true
                },
                type: 'POST',
                data: {csrfmiddlewaretoken: '{{csrf_token}}'},
                accepts: 'application/json',
                dataType: 'json',
                success: function(result){
                    verifica_aberto();
                    tableProjetos.ajax.reload(null, false);
                },
                error: function(xhr, status, error) {
                    console.log(status);
                    console.log(error);
                    console.log(xhr);
                }
            })
        }

        

    </script>

{% endblock %}